<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Hubtel PayProxy API</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; margin: 0; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .info { background: #d1ecf1; padding: 15px; border-radius: 5px; margin: 15px 0; border-left: 4px solid #0c5460; }
        .success { background: #d4edda; padding: 15px; border-radius: 5px; margin: 15px 0; border-left: 4px solid #155724; }
        .error { background: #f8d7da; padding: 15px; border-radius: 5px; margin: 15px 0; border-left: 4px solid #721c24; }
        .warning { background: #fff3cd; padding: 15px; border-radius: 5px; margin: 15px 0; border-left: 4px solid #856404; }
        button { padding: 15px 25px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; margin: 10px; font-size: 16px; font-weight: bold; }
        button:hover { background: #0056b3; }
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #218838; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-warning:hover { background: #e0a800; }
        pre { background: #f8f9fa; padding: 15px; border-radius: 5px; overflow-x: auto; font-size: 14px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input { padding: 10px; width: 100%; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        .endpoint-info { background: #e9ecef; padding: 15px; border-radius: 5px; margin: 15px 0; }
        .comparison { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
        .comparison > div { padding: 15px; border-radius: 5px; }
        .old { background: #f8d7da; border-left: 4px solid #dc3545; }
        .new { background: #d4edda; border-left: 4px solid #28a745; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Hubtel PayProxy API Test</h1>
        <p style="text-align: center; color: #666; margin-bottom: 30px;">Testing with correct endpoint from church management system</p>
        
        <div class="comparison">
            <div class="old">
                <h4>‚ùå Previous (Wrong)</h4>
                <strong>Base URL:</strong> https://rmp.hubtel.com<br>
                <strong>Endpoint:</strong> /merchantaccount/merchants/{posId}/receive/ussd<br>
                <strong>Callback:</strong> Custom webhook URL<br>
                <strong>Result:</strong> 403 Forbidden
            </div>
            <div class="new">
                <h4>‚úÖ Current (Correct)</h4>
                <strong>Base URL:</strong> https://payproxyapi.hubtel.com<br>
                <strong>Endpoint:</strong> /items/initiate<br>
                <strong>Callback:</strong> https://gs-callback.hubtel.com/callback<br>
                <strong>Result:</strong> Testing now...
            </div>
        </div>
        
        <div class="info">
            <h3>üîß Key Changes Applied:</h3>
            <ul>
                <li><strong>API Base URL:</strong> Changed to PayProxy API (payproxyapi.hubtel.com)</li>
                <li><strong>Endpoint:</strong> Using /items/initiate from church management system</li>
                <li><strong>Callback URL:</strong> Using Hubtel's gateway service callback</li>
                <li><strong>Multiple Endpoints:</strong> Will try alternative endpoints if primary fails</li>
            </ul>
        </div>
        
        <form id="testForm">
            <div class="form-group">
                <label>Event ID:</label>
                <input type="number" name="event_id" value="1" required>
            </div>
            <div class="form-group">
                <label>Nominee ID:</label>
                <input type="number" name="nominee_id" value="1" required>
            </div>
            <div class="form-group">
                <label>Vote Count:</label>
                <input type="number" name="vote_count" value="1" min="1" max="10" required>
            </div>
            <div class="form-group">
                <label>Voter Name:</label>
                <input type="text" name="voter_name" value="Test Voter" required>
            </div>
            <div class="form-group">
                <label>Phone Number:</label>
                <input type="tel" name="phone_number" value="0241234567" required>
            </div>
            <div class="form-group">
                <label>Email (Optional):</label>
                <input type="email" name="email" value="test@example.com">
            </div>
        </form>
        
        <div style="text-align: center; margin: 30px 0;">
            <button class="btn-success" onclick="testPayProxyAPI()">üéØ Test PayProxy API</button>
            <button class="btn-warning" onclick="debugAllEndpoints()">üîç Debug All Endpoints</button>
            <button onclick="compareWithOldAPI()">üìä Compare with Old API</button>
        </div>
        
        <div id="testResult"></div>
    </div>
    
    <script>
        function testPayProxyAPI() {
            const form = document.getElementById('testForm');
            const formData = new FormData(form);
            const resultDiv = document.getElementById('testResult');
            
            resultDiv.innerHTML = `<div class="info">
                <h3>üöÄ Testing PayProxy API</h3>
                <p><strong>Endpoint:</strong> https://payproxyapi.hubtel.com/items/initiate</p>
                <p><strong>Callback:</strong> https://gs-callback.hubtel.com/callback</p>
                <p>Please wait...</p>
            </div>`;
            
            fetch('voter/actions/hubtel-ussd-vote-submit.php', {
                method: 'POST',
                body: formData,
                cache: 'no-cache'
            })
            .then(response => response.text())
            .then(text => {
                console.log('PayProxy API Response:', text);
                
                try {
                    const data = JSON.parse(text);
                    
                    if (data.success) {
                        resultDiv.innerHTML = `<div class="success">
                            <h3>üéâ PayProxy API Success!</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 15px 0;">
                                <div><strong>Status:</strong> ${data.status || 'Success'}</div>
                                <div><strong>Transaction Ref:</strong> ${data.transaction_ref}</div>
                                <div><strong>USSD Code:</strong> ${data.ussd_code || 'Generated'}</div>
                                <div><strong>Amount:</strong> GHS ${data.amount}</div>
                                <div><strong>Endpoint Used:</strong> ${data.endpoint_used || '/items/initiate'}</div>
                                <div><strong>Vote Count:</strong> ${data.vote_count}</div>
                            </div>
                            
                            ${data.instructions ? `
                                <div class="endpoint-info">
                                    <h4>üì± Payment Instructions:</h4>
                                    <ol>
                                        ${data.instructions.map(instruction => `<li>${instruction}</li>`).join('')}
                                    </ol>
                                </div>
                            ` : ''}
                            
                            <p><strong>Message:</strong> ${data.message}</p>
                            
                            <details style="margin-top: 15px;">
                                <summary><strong>Full API Response</strong></summary>
                                <pre>${JSON.stringify(data, null, 2)}</pre>
                            </details>
                        </div>`;
                    } else {
                        const isEndpointIssue = data.error_code === 'UNKNOWN_ERROR' || data.message.includes('403');
                        
                        resultDiv.innerHTML = `<div class="${isEndpointIssue ? 'warning' : 'error'}">
                            <h3>${isEndpointIssue ? '‚ö†Ô∏è' : '‚ùå'} PayProxy API ${isEndpointIssue ? 'Issue' : 'Failed'}</h3>
                            <p><strong>Message:</strong> ${data.message}</p>
                            <p><strong>Error Code:</strong> ${data.error_code}</p>
                            ${data.endpoint_tried ? `<p><strong>Endpoint Tried:</strong> ${data.endpoint_tried}</p>` : ''}
                            
                            ${isEndpointIssue ? `
                                <div class="info" style="margin-top: 15px;">
                                    <h4>üîß Possible Solutions:</h4>
                                    <ul>
                                        <li>The PayProxy API might need different authentication</li>
                                        <li>Try the debug tool to test all endpoints</li>
                                        <li>Contact Hubtel support for PayProxy API access</li>
                                        <li>Verify the church management system implementation details</li>
                                    </ul>
                                </div>
                            ` : ''}
                            
                            <details style="margin-top: 15px;">
                                <summary><strong>Full Error Response</strong></summary>
                                <pre>${JSON.stringify(data, null, 2)}</pre>
                            </details>
                        </div>`;
                    }
                } catch (parseError) {
                    resultDiv.innerHTML = `<div class="error">
                        <h3>‚ö†Ô∏è Response Parse Error</h3>
                        <p>The API returned a non-JSON response, indicating a server-level issue.</p>
                        <details>
                            <summary><strong>Raw Server Response</strong></summary>
                            <pre>${text}</pre>
                        </details>
                    </div>`;
                }
            })
            .catch(error => {
                resultDiv.innerHTML = `<div class="error">
                    <h3>üåê Network Error</h3>
                    <p><strong>Error:</strong> ${error.message}</p>
                    <p>Could not reach the PayProxy API endpoint.</p>
                </div>`;
            });
        }
        
        function debugAllEndpoints() {
            const resultDiv = document.getElementById('testResult');
            
            resultDiv.innerHTML = '<div class="info"><strong>Opening comprehensive endpoint debug tool...</strong></div>';
            
            window.open('debug-hubtel-ussd.php', '_blank', 'width=1200,height=800,scrollbars=yes');
            
            setTimeout(() => {
                resultDiv.innerHTML = `<div class="info">
                    <h3>üîç Debug Tool Opened</h3>
                    <p>The debug tool will test:</p>
                    <ul>
                        <li>PayProxy API connectivity</li>
                        <li>Multiple endpoint variations</li>
                        <li>Authentication methods</li>
                        <li>Response analysis</li>
                    </ul>
                    <p>Check the new window for detailed results.</p>
                </div>`;
            }, 1000);
        }
        
        function compareWithOldAPI() {
            const resultDiv = document.getElementById('testResult');
            
            resultDiv.innerHTML = `<div class="info">
                <h3>üìä API Comparison</h3>
                <div class="comparison">
                    <div class="old">
                        <h4>Old API (Failed)</h4>
                        <p><strong>URL:</strong> https://rmp.hubtel.com/merchantaccount/merchants/2031233/receive/ussd</p>
                        <p><strong>Error:</strong> 403 Forbidden</p>
                        <p><strong>Issue:</strong> Wrong endpoint structure</p>
                    </div>
                    <div class="new">
                        <h4>New API (Testing)</h4>
                        <p><strong>URL:</strong> https://payproxyapi.hubtel.com/items/initiate</p>
                        <p><strong>Callback:</strong> https://gs-callback.hubtel.com/callback</p>
                        <p><strong>Source:</strong> Church management system</p>
                    </div>
                </div>
                <p><strong>Key Insight:</strong> Hubtel uses PayProxy API for USSD payments, not the direct merchant API.</p>
            </div>`;
        }
    </script>
</body>
</html>
