<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Church System PayProxy Implementation</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; margin: 0; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .info { background: #d1ecf1; padding: 15px; border-radius: 5px; margin: 15px 0; border-left: 4px solid #0c5460; }
        .success { background: #d4edda; padding: 15px; border-radius: 5px; margin: 15px 0; border-left: 4px solid #155724; }
        .error { background: #f8d7da; padding: 15px; border-radius: 5px; margin: 15px 0; border-left: 4px solid #721c24; }
        .warning { background: #fff3cd; padding: 15px; border-radius: 5px; margin: 15px 0; border-left: 4px solid #856404; }
        button { padding: 15px 25px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; margin: 10px; font-size: 16px; font-weight: bold; }
        button:hover { background: #0056b3; }
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #218838; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-warning:hover { background: #e0a800; }
        pre { background: #f8f9fa; padding: 15px; border-radius: 5px; overflow-x: auto; font-size: 14px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input { padding: 10px; width: 100%; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        .comparison { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
        .comparison > div { padding: 15px; border-radius: 5px; }
        .old { background: #f8d7da; border-left: 4px solid #dc3545; }
        .new { background: #d4edda; border-left: 4px solid #28a745; }
        .code-block { background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 10px 0; font-family: monospace; font-size: 12px; }
        .checkout-link { background: #007bff; color: white; padding: 10px 20px; border-radius: 5px; text-decoration: none; display: inline-block; margin: 10px 0; }
        .checkout-link:hover { background: #0056b3; color: white; text-decoration: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üèõÔ∏è Church System PayProxy Implementation</h1>
        <p style="text-align: center; color: #666; margin-bottom: 30px;">Testing with exact church management system structure</p>
        
        <div class="info">
            <h3>üîç Key Insights from Church System:</h3>
            <div class="comparison">
                <div class="old">
                    <h4>‚ùå Our Previous Attempt</h4>
                    <strong>Parameters:</strong> CustomerName, CustomerMsisdn, Channel, Amount<br>
                    <strong>Auth:</strong> Basic Auth with API Key:Secret<br>
                    <strong>Result:</strong> 401 Unauthorized
                </div>
                <div class="new">
                    <h4>‚úÖ Church System (Working)</h4>
                    <strong>Parameters:</strong> totalAmount, payeeName, payeeMobileNumber, merchantAccountNumber<br>
                    <strong>Auth:</strong> Basic Auth with specific format<br>
                    <strong>Result:</strong> Returns checkoutUrl
                </div>
            </div>
        </div>
        
        <div class="warning">
            <h3>üîß Key Differences Identified:</h3>
            <ul>
                <li><strong>Parameter Names:</strong> totalAmount (not Amount), payeeName (not CustomerName)</li>
                <li><strong>Merchant Account:</strong> Uses merchantAccountNumber field</li>
                <li><strong>Response:</strong> Returns checkoutUrl for payment page</li>
                <li><strong>Flow:</strong> Creates checkout page, not direct USSD code</li>
            </ul>
        </div>
        
        <form id="testForm">
            <div class="form-group">
                <label>Event ID:</label>
                <input type="number" name="event_id" value="1" required>
            </div>
            <div class="form-group">
                <label>Nominee ID:</label>
                <input type="number" name="nominee_id" value="1" required>
            </div>
            <div class="form-group">
                <label>Vote Count:</label>
                <input type="number" name="vote_count" value="1" min="1" max="10" required>
            </div>
            <div class="form-group">
                <label>Voter Name:</label>
                <input type="text" name="voter_name" value="Test Voter" required>
            </div>
            <div class="form-group">
                <label>Phone Number:</label>
                <input type="tel" name="phone_number" value="0241234567" required>
            </div>
            <div class="form-group">
                <label>Email (Optional):</label>
                <input type="email" name="email" value="test@example.com">
            </div>
        </form>
        
        <div style="text-align: center; margin: 30px 0;">
            <button class="btn-success" onclick="testChurchSystemPayProxy()">üèõÔ∏è Test Church System PayProxy</button>
            <button class="btn-warning" onclick="testAuthMethods()">üîê Test Auth Methods</button>
            <button onclick="showImplementationDetails()">üìã Show Implementation</button>
        </div>
        
        <div id="testResult"></div>
    </div>
    
    <script>
        function testChurchSystemPayProxy() {
            const form = document.getElementById('testForm');
            const formData = new FormData(form);
            const resultDiv = document.getElementById('testResult');
            
            resultDiv.innerHTML = `<div class="info">
                <h3>üèõÔ∏è Testing Church System PayProxy Implementation</h3>
                <p><strong>Endpoint:</strong> https://payproxyapi.hubtel.com/items/initiate</p>
                <p><strong>Parameters:</strong> totalAmount, payeeName, payeeMobileNumber, merchantAccountNumber</p>
                <p><strong>Expected:</strong> checkoutUrl for payment page</p>
                <p>Please wait...</p>
            </div>`;
            
            fetch('voter/actions/hubtel-payproxy-vote-submit.php', {
                method: 'POST',
                body: formData,
                cache: 'no-cache'
            })
            .then(response => response.text())
            .then(text => {
                console.log('PayProxy Response:', text);
                
                try {
                    const data = JSON.parse(text);
                    
                    if (data.success) {
                        resultDiv.innerHTML = `<div class="success">
                            <h3>üéâ Church System PayProxy Success!</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 15px 0;">
                                <div><strong>Status:</strong> ${data.status}</div>
                                <div><strong>Transaction Ref:</strong> ${data.transaction_ref}</div>
                                <div><strong>Checkout ID:</strong> ${data.checkout_id || 'Generated'}</div>
                                <div><strong>Amount:</strong> GHS ${data.amount}</div>
                                <div><strong>Vote Count:</strong> ${data.vote_count}</div>
                                <div><strong>Nominee:</strong> ${data.nominee_name}</div>
                            </div>
                            
                            ${data.checkout_url ? `
                                <div class="info">
                                    <h4>üí≥ Payment Checkout Created!</h4>
                                    <p>A secure payment page has been created. Click the link below to complete payment:</p>
                                    <a href="${data.checkout_url}" target="_blank" class="checkout-link">
                                        üîó Open Payment Page
                                    </a>
                                    <p><small>This will open Hubtel's secure payment page where you can pay with Mobile Money, Bank Card, or other methods.</small></p>
                                </div>
                            ` : ''}
                            
                            ${data.instructions ? `
                                <div class="warning">
                                    <h4>üì± Payment Instructions:</h4>
                                    <ol>
                                        ${data.instructions.map(instruction => `<li>${instruction}</li>`).join('')}
                                    </ol>
                                </div>
                            ` : ''}
                            
                            <p><strong>Message:</strong> ${data.message}</p>
                            
                            <details style="margin-top: 15px;">
                                <summary><strong>Full API Response</strong></summary>
                                <pre>${JSON.stringify(data, null, 2)}</pre>
                            </details>
                        </div>`;
                    } else {
                        const isAuthIssue = data.error_code === 'PAYPROXY_FAILED' || data.message.includes('401');
                        
                        resultDiv.innerHTML = `<div class="${isAuthIssue ? 'warning' : 'error'}">
                            <h3>${isAuthIssue ? 'üîê' : '‚ùå'} PayProxy ${isAuthIssue ? 'Authentication Issue' : 'Failed'}</h3>
                            <p><strong>Message:</strong> ${data.message}</p>
                            <p><strong>Error Code:</strong> ${data.error_code}</p>
                            
                            ${data.debug ? `
                                <div class="code-block">
                                    <strong>Debug Info:</strong><br>
                                    HTTP Code: ${data.debug.http_code}<br>
                                    ${data.debug.response ? 'Response: ' + JSON.stringify(data.debug.response, null, 2) : ''}
                                </div>
                            ` : ''}
                            
                            ${isAuthIssue ? `
                                <div class="info" style="margin-top: 15px;">
                                    <h4>üîß Possible Solutions:</h4>
                                    <ul>
                                        <li>Check if your Hubtel credentials have PayProxy API access</li>
                                        <li>Verify the merchantAccountNumber (POS ID) is correct</li>
                                        <li>Contact Hubtel support for PayProxy API activation</li>
                                        <li>Try the auth methods test to find correct authentication</li>
                                    </ul>
                                </div>
                            ` : ''}
                            
                            <details style="margin-top: 15px;">
                                <summary><strong>Full Error Response</strong></summary>
                                <pre>${JSON.stringify(data, null, 2)}</pre>
                            </details>
                        </div>`;
                    }
                } catch (parseError) {
                    resultDiv.innerHTML = `<div class="error">
                        <h3>‚ö†Ô∏è Response Parse Error</h3>
                        <p>The API returned a non-JSON response.</p>
                        <details>
                            <summary><strong>Raw Server Response</strong></summary>
                            <pre>${text}</pre>
                        </details>
                    </div>`;
                }
            })
            .catch(error => {
                resultDiv.innerHTML = `<div class="error">
                    <h3>üåê Network Error</h3>
                    <p><strong>Error:</strong> ${error.message}</p>
                </div>`;
            });
        }
        
        function testAuthMethods() {
            const resultDiv = document.getElementById('testResult');
            
            resultDiv.innerHTML = '<div class="info"><strong>Opening authentication methods test...</strong></div>';
            
            window.open('test-payproxy-auth-methods.php', '_blank', 'width=1200,height=800,scrollbars=yes');
            
            setTimeout(() => {
                resultDiv.innerHTML = `<div class="info">
                    <h3>üîê Authentication Test Opened</h3>
                    <p>The auth test will try different authentication methods to find the correct one for PayProxy API.</p>
                    <p>Check the new window for detailed results.</p>
                </div>`;
            }, 1000);
        }
        
        function showImplementationDetails() {
            const resultDiv = document.getElementById('testResult');
            
            resultDiv.innerHTML = `<div class="info">
                <h3>üìã Church System Implementation Details</h3>
                
                <h4>üîß Key Parameters (Church System):</h4>
                <div class="code-block">
{
    "totalAmount": 1.00,
    "description": "Vote for Nominee",
    "callbackUrl": "https://gs-callback.hubtel.com/callback",
    "returnUrl": "https://yoursite.com/success",
    "merchantAccountNumber": "2031233",
    "cancellationUrl": "https://yoursite.com/cancel",
    "clientReference": "PAYPROXY_123456",
    "payeeName": "Voter Name",
    "payeeMobileNumber": "233241234567",
    "payeeEmail": "voter@example.com"
}
                </div>
                
                <h4>üîê Authentication (Church System):</h4>
                <div class="code-block">
Headers:
- Content-Type: application/json
- Accept: application/json
- Authorization: Basic [base64_encoded_credentials]
                </div>
                
                <h4>‚úÖ Expected Response:</h4>
                <div class="code-block">
{
    "checkoutUrl": "https://checkout.hubtel.com/...",
    "checkoutDirectUrl": "https://...",
    "checkoutId": "12345",
    "clientReference": "PAYPROXY_123456"
}
                </div>
                
                <h4>üéØ Implementation Benefits:</h4>
                <ul>
                    <li><strong>Secure Checkout:</strong> Users get a secure Hubtel payment page</li>
                    <li><strong>Multiple Payment Methods:</strong> Mobile Money, Cards, Bank transfers</li>
                    <li><strong>Proven Working:</strong> Based on successful church system</li>
                    <li><strong>Better UX:</strong> Professional payment interface</li>
                </ul>
            </div>`;
        }
    </script>
</body>
</html>
